name: Integration Tests

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:
    inputs:
      test_filter:
        description: 'Run specific test (e.g., kotlin-hello-world, agentic-patterns/chain-workflow)'
        required: false
        default: ''
        type: string

jobs:
  integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Set up Python 3
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code --silent
          echo "✅ Claude Code CLI installed via npm"

      - name: Verify Claude Code installation
        run: |
          if command -v claude >/dev/null 2>&1; then
            echo "✅ Claude CLI verified: $(claude --version 2>&1 || echo 'version check skipped')"
          else
            echo "⚠️ Claude CLI not found in PATH (AI validation will be skipped)"
          fi

      - name: Install JBang
        run: |
          curl -Ls https://sh.jbang.dev | bash -s - app setup
          echo "$HOME/.jbang/bin" >> "$GITHUB_PATH"

      - name: Verify JBang installation
        run: |
          export PATH="$HOME/.jbang/bin:$PATH"
          jbang version
          java -version

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y sqlite3

      - name: Cache JBang dependencies
        uses: actions/cache@v4
        with:
          path: ~/.jbang
          key: ${{ runner.os }}-jbang-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-jbang-

      - name: Run integration tests
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SPRING_AI_OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SPRING_AI_ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          BRAVE_API_KEY: ${{ secrets.BRAVE_API_KEY }}
        run: |
          if [ -n "${{ inputs.test_filter }}" ]; then
            echo "Running specific test: ${{ inputs.test_filter }}"
            ./integration-testing/scripts/run-integration-tests.sh "${{ inputs.test_filter }}"
          else
            echo "Running all integration tests"
            ./integration-testing/scripts/run-integration-tests.sh
          fi

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-logs-${{ github.run_number }}
          path: |
            integration-testing/logs/**/*.log
          retention-days: 7

      - name: Summary
        if: always()
        run: |
          echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Filter**: ${{ inputs.test_filter || 'All tests' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Required Secrets" >> $GITHUB_STEP_SUMMARY
          echo "- \`OPENAI_API_KEY\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`ANTHROPIC_API_KEY\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`BRAVE_API_KEY\`" >> $GITHUB_STEP_SUMMARY
